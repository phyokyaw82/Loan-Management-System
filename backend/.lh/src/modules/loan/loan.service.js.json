{
    "sourceFile": "src/modules/loan/loan.service.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1770586657909,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770586983172,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,38 +1,35 @@\n-import Loan from \"./loan.model.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../models/Loan.js\";\r\n \r\n-class LoanService {\r\n-    async createLoan(data) {\r\n-        return Loan.create(data);\r\n-    }\r\n+// Create Loan\r\n+export const createLoan = async (data) => {\r\n+    const totalAmount = data.amount * (1 + data.interestRate / 100);\r\n+    const loan = new Loan({\r\n+        ...data,\r\n+        totalAmount,\r\n+        balance: totalAmount\r\n+    });\r\n+    return await loan.save();\r\n+};\r\n \r\n-    async getAllLoans() {\r\n-        const loans = await Loan.find().populate(\"borrower\");\r\n-        const loansWithBalance = await Promise.all(\r\n-            loans.map(async loan => {\r\n-                const balance = await computeLoanBalance(loan._id);\r\n-                return { ...loan.toObject(), balance };\r\n-            })\r\n-        );\r\n-        return loansWithBalance;\r\n-    }\r\n+// Update Loan\r\n+export const updateLoan = async (id, data) => {\r\n+    const loan = await Loan.findById(id);\r\n+    if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-    async getLoanById(id) {\r\n-        const loan = await Loan.findById(id).populate(\"borrower\");\r\n-        if (!loan) return null;\r\n-\r\n-        const balance = await computeLoanBalance(loan._id);\r\n-        return { ...loan.toObject(), balance };\r\n+    // Recalculate totalAmount and balance if amount or interestRate changes\r\n+    if (data.amount !== undefined || data.interestRate !== undefined) {\r\n+        const newTotal = data.amount * (1 + data.interestRate / 100);\r\n+        const paid = loan.totalAmount - loan.balance; // amount already paid\r\n+        loan.totalAmount = newTotal;\r\n+        loan.balance = newTotal - paid; // preserve repayments\r\n     }\r\n \r\n-    async updateLoan(id, data) {\r\n-        return Loan.findByIdAndUpdate(id, data, { new: true }).populate(\"borrower\");\r\n-    }\r\n+    Object.assign(loan, data);\r\n+    return await loan.save();\r\n+};\r\n \r\n-    async deleteLoan(id) {\r\n-        return Loan.findByIdAndDelete(id);\r\n-    }\r\n-}\r\n+// Get all loans\r\n+export const getLoans = async () => Loan.find().populate(\"borrower\");\r\n \r\n-export default new LoanService();\r\n-\r\n+// Get loan by ID\r\n+export const getLoanById = async (id) => Loan.findById(id).populate(\"borrower\");\r\n"
                },
                {
                    "date": 1770587110615,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,35 +1,38 @@\n-import Loan from \"../models/Loan.js\";\r\n+import Loan from \"./loan.model.js\";\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n-// Create Loan\r\n-export const createLoan = async (data) => {\r\n-    const totalAmount = data.amount * (1 + data.interestRate / 100);\r\n-    const loan = new Loan({\r\n-        ...data,\r\n-        totalAmount,\r\n-        balance: totalAmount\r\n-    });\r\n-    return await loan.save();\r\n-};\r\n+class LoanService {\r\n+    async createLoan(data) {\r\n+        return Loan.create(data);\r\n+    }\r\n \r\n-// Update Loan\r\n-export const updateLoan = async (id, data) => {\r\n-    const loan = await Loan.findById(id);\r\n-    if (!loan) throw new Error(\"Loan not found\");\r\n+    async getAllLoans() {\r\n+        const loans = await Loan.find().populate(\"borrower\");\r\n+        const loansWithBalance = await Promise.all(\r\n+            loans.map(async loan => {\r\n+                const balance = await computeLoanBalance(loan._id);\r\n+                return { ...loan.toObject(), balance };\r\n+            })\r\n+        );\r\n+        return loansWithBalance;\r\n+    }\r\n \r\n-    // Recalculate totalAmount and balance if amount or interestRate changes\r\n-    if (data.amount !== undefined || data.interestRate !== undefined) {\r\n-        const newTotal = data.amount * (1 + data.interestRate / 100);\r\n-        const paid = loan.totalAmount - loan.balance; // amount already paid\r\n-        loan.totalAmount = newTotal;\r\n-        loan.balance = newTotal - paid; // preserve repayments\r\n+    async getLoanById(id) {\r\n+        const loan = await Loan.findById(id).populate(\"borrower\");\r\n+        if (!loan) return null;\r\n+\r\n+        const balance = await computeLoanBalance(loan._id);\r\n+        return { ...loan.toObject(), balance };\r\n     }\r\n \r\n-    Object.assign(loan, data);\r\n-    return await loan.save();\r\n-};\r\n+    async updateLoan(id, data) {\r\n+        return Loan.findByIdAndUpdate(id, data, { new: true }).populate(\"borrower\");\r\n+    }\r\n \r\n-// Get all loans\r\n-export const getLoans = async () => Loan.find().populate(\"borrower\");\r\n+    async deleteLoan(id) {\r\n+        return Loan.findByIdAndDelete(id);\r\n+    }\r\n+}\r\n \r\n-// Get loan by ID\r\n-export const getLoanById = async (id) => Loan.findById(id).populate(\"borrower\");\r\n+export default new LoanService();\r\n+\r\n"
                },
                {
                    "date": 1770587243337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,73 @@\n+// import Loan from \"./loan.model.js\";\r\n+// import Transaction from \"../transaction/transaction.model.js\";\r\n+// import Repayment from \"../repayment/repayment.model.js\";\r\n+\r\n+// class LoanService {\r\n+//     async createLoan(data) {\r\n+//         return Loan.create(data);\r\n+//     }\r\n+\r\n+//     // ✅ Fetch all loans with calculated balance\r\n+//     async getAllLoans() {\r\n+//         const loans = await Loan.find().populate(\"borrower\");\r\n+\r\n+//         const loansWithBalance = await Promise.all(\r\n+//             loans.map(async (loan) => {\r\n+//                 const transactions = await Transaction.find({ loan: loan._id });\r\n+//                 const repayments = await Repayment.find({ loan: loan._id });\r\n+\r\n+//                 let balance = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n+\r\n+//                 transactions.forEach(tx => {\r\n+//                     if (tx.type === \"Late Fee\" || tx.type === \"Penalty\") balance += tx.amount;\r\n+//                     if (tx.type === \"Repayment\") balance -= tx.amount;\r\n+//                 });\r\n+\r\n+//                 repayments.forEach(rp => {\r\n+//                     balance -= rp.amountPaid || 0;\r\n+//                 });\r\n+\r\n+//                 return { ...loan.toObject(), balance };\r\n+//             })\r\n+//         );\r\n+\r\n+//         return loansWithBalance;\r\n+//     }\r\n+\r\n+//     // ✅ Fetch single loan with calculated balance\r\n+//     async getLoanById(id) {\r\n+//         const loan = await Loan.findById(id).populate(\"borrower\");\r\n+//         if (!loan) return null;\r\n+\r\n+//         const transactions = await Transaction.find({ loan: loan._id });\r\n+//         const repayments = await Repayment.find({ loan: loan._id });\r\n+\r\n+//         let balance = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n+\r\n+//         transactions.forEach(tx => {\r\n+//             if (tx.type === \"Late Fee\" || tx.type === \"Penalty\") balance += tx.amount;\r\n+//             if (tx.type === \"Repayment\") balance -= tx.amount;\r\n+//         });\r\n+\r\n+//         repayments.forEach(rp => {\r\n+//             balance -= rp.amountPaid || 0;\r\n+//         });\r\n+\r\n+//         return { ...loan.toObject(), balance };\r\n+//     }\r\n+\r\n+//     async updateLoan(id, data) {\r\n+//         return Loan.findByIdAndUpdate(id, data, { new: true }).populate(\"borrower\");\r\n+//     }\r\n+\r\n+//     async deleteLoan(id) {\r\n+//         return Loan.findByIdAndDelete(id);\r\n+//     }\r\n+// }\r\n+\r\n+// export default new LoanService();\r\n+\r\n import Loan from \"./loan.model.js\";\r\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class LoanService {\r\n"
                }
            ],
            "date": 1770586657909,
            "name": "Commit-0",
            "content": "import Loan from \"./loan.model.js\";\r\nimport { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n\r\nclass LoanService {\r\n    async createLoan(data) {\r\n        return Loan.create(data);\r\n    }\r\n\r\n    async getAllLoans() {\r\n        const loans = await Loan.find().populate(\"borrower\");\r\n        const loansWithBalance = await Promise.all(\r\n            loans.map(async loan => {\r\n                const balance = await computeLoanBalance(loan._id);\r\n                return { ...loan.toObject(), balance };\r\n            })\r\n        );\r\n        return loansWithBalance;\r\n    }\r\n\r\n    async getLoanById(id) {\r\n        const loan = await Loan.findById(id).populate(\"borrower\");\r\n        if (!loan) return null;\r\n\r\n        const balance = await computeLoanBalance(loan._id);\r\n        return { ...loan.toObject(), balance };\r\n    }\r\n\r\n    async updateLoan(id, data) {\r\n        return Loan.findByIdAndUpdate(id, data, { new: true }).populate(\"borrower\");\r\n    }\r\n\r\n    async deleteLoan(id) {\r\n        return Loan.findByIdAndDelete(id);\r\n    }\r\n}\r\n\r\nexport default new LoanService();\r\n\r\n"
        }
    ]
}