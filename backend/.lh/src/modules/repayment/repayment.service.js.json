{
    "sourceFile": "src/modules/repayment/repayment.service.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 36,
            "patches": [
                {
                    "date": 1770586657525,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770586709195,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,10 +2,10 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n+        const repayment = await repaymentRepository.create(data);\r\n         repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        const repayment = await repaymentRepository.create(data);\r\n         await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n"
                },
                {
                    "date": 1770586983163,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,38 +1,54 @@\n-import repaymentRepository from \"./repayment.repository.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Repayment from \"../models/Repayment.js\";\r\n+import Loan from \"../models/Loan.js\";\r\n \r\n-class RepaymentService {\r\n-    async createRepayment(data) {\r\n-        const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        await repayment.save();\r\n-        return repayment;\r\n+// Create Repayment\r\n+export const createRepayment = async (data) => {\r\n+    const loan = await Loan.findById(data.loan);\r\n+    if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+    // Check repayment does not exceed loan balance\r\n+    if (data.amountPaid > loan.balance) {\r\n+        throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n     }\r\n \r\n-    async updatePayment(id, data) {\r\n-        const repayment = await repaymentRepository.findById(id);\r\n-        if (!repayment) throw new Error(\"Repayment not found\");\r\n+    const repayment = new Repayment(data);\r\n+    await repayment.save();\r\n \r\n-        Object.assign(repayment, data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        return repayment.save();\r\n-    }\r\n+    // Deduct repayment from loan balance\r\n+    loan.balance -= data.amountPaid;\r\n+    await loan.save();\r\n \r\n-    async getAllRepayments() {\r\n-        return repaymentRepository.findAll();\r\n-    }\r\n+    return repayment;\r\n+};\r\n \r\n-    async getRepaymentsByLoan(loanId) {\r\n-        return repaymentRepository.findByLoan(loanId);\r\n-    }\r\n+// Update Repayment\r\n+export const updateRepayment = async (id, data) => {\r\n+    const repayment = await Repayment.findById(id);\r\n+    if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-    async getRepaymentById(id) {\r\n-        return repaymentRepository.findById(id);\r\n-    }\r\n+    const loan = await Loan.findById(repayment.loan);\r\n+    if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-    async deleteRepayment(id) {\r\n-        return repaymentRepository.delete(id);\r\n+    // Revert previous repayment\r\n+    loan.balance += repayment.amountPaid;\r\n+\r\n+    // Check new amountPaid does not exceed balance\r\n+    if (data.amountPaid > loan.balance) {\r\n+        throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n     }\r\n-}\r\n \r\n-export default new RepaymentService();\r\n+    Object.assign(repayment, data);\r\n+    await repayment.save();\r\n+\r\n+    // Deduct updated repayment from loan\r\n+    loan.balance -= data.amountPaid;\r\n+    await loan.save();\r\n+\r\n+    return repayment;\r\n+};\r\n+\r\n+// Get all repayments\r\n+export const getRepayments = async () => Repayment.find().populate(\"loan\");\r\n+\r\n+// Get repayment by ID\r\n+export const getRepaymentById = async (id) => Repayment.findById(id).populate(\"loan\");\r\n"
                },
                {
                    "date": 1770587142526,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,54 +1,38 @@\n-import Repayment from \"../models/Repayment.js\";\r\n-import Loan from \"../models/Loan.js\";\r\n+import repaymentRepository from \"./repayment.repository.js\";\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n-// Create Repayment\r\n-export const createRepayment = async (data) => {\r\n-    const loan = await Loan.findById(data.loan);\r\n-    if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-    // Check repayment does not exceed loan balance\r\n-    if (data.amountPaid > loan.balance) {\r\n-        throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+class RepaymentService {\r\n+    async createRepayment(data) {\r\n+        const repayment = await repaymentRepository.create(data);\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        await repayment.save();\r\n+        return repayment;\r\n     }\r\n \r\n-    const repayment = new Repayment(data);\r\n-    await repayment.save();\r\n+    async updatePayment(id, data) {\r\n+        const repayment = await repaymentRepository.findById(id);\r\n+        if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-    // Deduct repayment from loan balance\r\n-    loan.balance -= data.amountPaid;\r\n-    await loan.save();\r\n+        Object.assign(repayment, data);\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        return repayment.save();\r\n+    }\r\n \r\n-    return repayment;\r\n-};\r\n+    async getAllRepayments() {\r\n+        return repaymentRepository.findAll();\r\n+    }\r\n \r\n-// Update Repayment\r\n-export const updateRepayment = async (id, data) => {\r\n-    const repayment = await Repayment.findById(id);\r\n-    if (!repayment) throw new Error(\"Repayment not found\");\r\n+    async getRepaymentsByLoan(loanId) {\r\n+        return repaymentRepository.findByLoan(loanId);\r\n+    }\r\n \r\n-    const loan = await Loan.findById(repayment.loan);\r\n-    if (!loan) throw new Error(\"Loan not found\");\r\n+    async getRepaymentById(id) {\r\n+        return repaymentRepository.findById(id);\r\n+    }\r\n \r\n-    // Revert previous repayment\r\n-    loan.balance += repayment.amountPaid;\r\n-\r\n-    // Check new amountPaid does not exceed balance\r\n-    if (data.amountPaid > loan.balance) {\r\n-        throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+    async deleteRepayment(id) {\r\n+        return repaymentRepository.delete(id);\r\n     }\r\n+}\r\n \r\n-    Object.assign(repayment, data);\r\n-    await repayment.save();\r\n-\r\n-    // Deduct updated repayment from loan\r\n-    loan.balance -= data.amountPaid;\r\n-    await loan.save();\r\n-\r\n-    return repayment;\r\n-};\r\n-\r\n-// Get all repayments\r\n-export const getRepayments = async () => Repayment.find().populate(\"loan\");\r\n-\r\n-// Get repayment by ID\r\n-export const getRepaymentById = async (id) => Repayment.findById(id).populate(\"loan\");\r\n+export default new RepaymentService();\r\n"
                },
                {
                    "date": 1770587207280,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,37 +1,84 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../models/Loan.js\"; // import your Loan model\r\n \r\n class RepaymentService {\r\n+    // Create a new repayment\r\n     async createRepayment(data) {\r\n+        // Find the loan\r\n+        const loan = await Loan.findById(data.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Validate repayment amount does not exceed loan balance\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Create repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        await repayment.save();\r\n+\r\n+        // Deduct repayment from loan balance\r\n+        loan.balance -= data.amountPaid;\r\n+        await loan.save();\r\n+\r\n         return repayment;\r\n     }\r\n \r\n+    // Update an existing repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n+        // Fetch the associated loan\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Revert previous repayment from loan balance\r\n+        loan.balance += repayment.amountPaid;\r\n+\r\n+        // Validate new amount does not exceed remaining balance\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Update repayment\r\n         Object.assign(repayment, data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        return repayment.save();\r\n+        await repayment.save();\r\n+\r\n+        // Deduct updated repayment from loan\r\n+        loan.balance -= data.amountPaid;\r\n+        await loan.save();\r\n+\r\n+        return repayment;\r\n     }\r\n \r\n+    // Get all repayments\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n+    // Get repayments by loan\r\n     async getRepaymentsByLoan(loanId) {\r\n         return repaymentRepository.findByLoan(loanId);\r\n     }\r\n \r\n+    // Get repayment by ID\r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n \r\n+    // Delete repayment\r\n     async deleteRepayment(id) {\r\n+        const repayment = await repaymentRepository.findById(id);\r\n+        if (!repayment) throw new Error(\"Repayment not found\");\r\n+\r\n+        // Refund repayment back to loan balance\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (loan) {\r\n+            loan.balance += repayment.amountPaid;\r\n+            await loan.save();\r\n+        }\r\n+\r\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n"
                },
                {
                    "date": 1770587243342,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,84 +1,37 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import Loan from \"../models/Loan.js\"; // import your Loan model\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n-    // Create a new repayment\r\n     async createRepayment(data) {\r\n-        // Find the loan\r\n-        const loan = await Loan.findById(data.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Validate repayment amount does not exceed loan balance\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Create repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n-\r\n-        // Deduct repayment from loan balance\r\n-        loan.balance -= data.amountPaid;\r\n-        await loan.save();\r\n-\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n-    // Update an existing repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-        // Fetch the associated loan\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Revert previous repayment from loan balance\r\n-        loan.balance += repayment.amountPaid;\r\n-\r\n-        // Validate new amount does not exceed remaining balance\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Update repayment\r\n         Object.assign(repayment, data);\r\n-        await repayment.save();\r\n-\r\n-        // Deduct updated repayment from loan\r\n-        loan.balance -= data.amountPaid;\r\n-        await loan.save();\r\n-\r\n-        return repayment;\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        return repayment.save();\r\n     }\r\n \r\n-    // Get all repayments\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n-    // Get repayments by loan\r\n     async getRepaymentsByLoan(loanId) {\r\n         return repaymentRepository.findByLoan(loanId);\r\n     }\r\n \r\n-    // Get repayment by ID\r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n \r\n-    // Delete repayment\r\n     async deleteRepayment(id) {\r\n-        const repayment = await repaymentRepository.findById(id);\r\n-        if (!repayment) throw new Error(\"Repayment not found\");\r\n-\r\n-        // Refund repayment back to loan balance\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (loan) {\r\n-            loan.balance += repayment.amountPaid;\r\n-            await loan.save();\r\n-        }\r\n-\r\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n"
                },
                {
                    "date": 1770587282017,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,37 +1,84 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../models/Loan.js\"; // import your Loan model\r\n \r\n class RepaymentService {\r\n+    // Create a new repayment\r\n     async createRepayment(data) {\r\n+        // Find the loan\r\n+        const loan = await Loan.findById(data.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Validate repayment amount does not exceed loan balance\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Create repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        await repayment.save();\r\n+\r\n+        // Deduct repayment from loan balance\r\n+        loan.balance -= data.amountPaid;\r\n+        await loan.save();\r\n+\r\n         return repayment;\r\n     }\r\n \r\n+    // Update an existing repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n+        // Fetch the associated loan\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Revert previous repayment from loan balance\r\n+        loan.balance += repayment.amountPaid;\r\n+\r\n+        // Validate new amount does not exceed remaining balance\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Update repayment\r\n         Object.assign(repayment, data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        return repayment.save();\r\n+        await repayment.save();\r\n+\r\n+        // Deduct updated repayment from loan\r\n+        loan.balance -= data.amountPaid;\r\n+        await loan.save();\r\n+\r\n+        return repayment;\r\n     }\r\n \r\n+    // Get all repayments\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n+    // Get repayments by loan\r\n     async getRepaymentsByLoan(loanId) {\r\n         return repaymentRepository.findByLoan(loanId);\r\n     }\r\n \r\n+    // Get repayment by ID\r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n \r\n+    // Delete repayment\r\n     async deleteRepayment(id) {\r\n+        const repayment = await repaymentRepository.findById(id);\r\n+        if (!repayment) throw new Error(\"Repayment not found\");\r\n+\r\n+        // Refund repayment back to loan balance\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (loan) {\r\n+            loan.balance += repayment.amountPaid;\r\n+            await loan.save();\r\n+        }\r\n+\r\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n"
                },
                {
                    "date": 1770587304554,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,84 +1,37 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import Loan from \"../models/Loan.js\"; // import your Loan model\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n-    // Create a new repayment\r\n     async createRepayment(data) {\r\n-        // Find the loan\r\n-        const loan = await Loan.findById(data.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Validate repayment amount does not exceed loan balance\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Create repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n-\r\n-        // Deduct repayment from loan balance\r\n-        loan.balance -= data.amountPaid;\r\n-        await loan.save();\r\n-\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n-    // Update an existing repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-        // Fetch the associated loan\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Revert previous repayment from loan balance\r\n-        loan.balance += repayment.amountPaid;\r\n-\r\n-        // Validate new amount does not exceed remaining balance\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Update repayment\r\n         Object.assign(repayment, data);\r\n-        await repayment.save();\r\n-\r\n-        // Deduct updated repayment from loan\r\n-        loan.balance -= data.amountPaid;\r\n-        await loan.save();\r\n-\r\n-        return repayment;\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        return repayment.save();\r\n     }\r\n \r\n-    // Get all repayments\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n-    // Get repayments by loan\r\n     async getRepaymentsByLoan(loanId) {\r\n         return repaymentRepository.findByLoan(loanId);\r\n     }\r\n \r\n-    // Get repayment by ID\r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n \r\n-    // Delete repayment\r\n     async deleteRepayment(id) {\r\n-        const repayment = await repaymentRepository.findById(id);\r\n-        if (!repayment) throw new Error(\"Repayment not found\");\r\n-\r\n-        // Refund repayment back to loan balance\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (loan) {\r\n-            loan.balance += repayment.amountPaid;\r\n-            await loan.save();\r\n-        }\r\n-\r\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n"
                },
                {
                    "date": 1770587367070,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,37 +1,86 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../models/Loan.js\"; // adjust path if needed\r\n \r\n class RepaymentService {\r\n+    // Create a new repayment\r\n     async createRepayment(data) {\r\n+        // Find the loan\r\n+        const loan = await Loan.findById(data.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Validate repayment amount\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Create and save repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        await repayment.save();\r\n+\r\n+        // Update loan balance\r\n+        loan.balance -= data.amountPaid;\r\n+        await loan.save();\r\n+\r\n         return repayment;\r\n     }\r\n \r\n+    // Update an existing repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-        Object.assign(repayment, data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        return repayment.save();\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        // Revert previous repayment\r\n+        loan.balance += repayment.amountPaid;\r\n+\r\n+        // Validate new amount\r\n+        if (data.amountPaid > loan.balance) {\r\n+            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n+        }\r\n+\r\n+        // Update repayment fields\r\n+        repayment.amountPaid = data.amountPaid;\r\n+        repayment.paymentDate = data.paymentDate;\r\n+        repayment.paymentTerm = data.paymentTerm;\r\n+        repayment.description = data.description;\r\n+\r\n+        await repaymentRepository.update(id, repayment); // use repo update\r\n+\r\n+        // Deduct updated repayment\r\n+        loan.balance -= repayment.amountPaid;\r\n+        await loan.save();\r\n+\r\n+        return repayment;\r\n     }\r\n \r\n+    // Get all repayments\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n+    // Get repayments by loan\r\n     async getRepaymentsByLoan(loanId) {\r\n         return repaymentRepository.findByLoan(loanId);\r\n     }\r\n \r\n+    // Get repayment by ID\r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n \r\n+    // Delete repayment\r\n     async deleteRepayment(id) {\r\n+        const repayment = await repaymentRepository.findById(id);\r\n+        if (!repayment) throw new Error(\"Repayment not found\");\r\n+\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        if (loan) {\r\n+            loan.balance += repayment.amountPaid; // refund\r\n+            await loan.save();\r\n+        }\r\n+\r\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n"
                },
                {
                    "date": 1770587501330,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,19 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import Loan from \"../models/Loan.js\"; // adjust path if needed\r\n+import Loan from \"../models/Loan.js\";\r\n \r\n class RepaymentService {\r\n-    // Create a new repayment\r\n+    // Create repayment\r\n     async createRepayment(data) {\r\n-        // Find the loan\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n         // Validate repayment amount\r\n         if (data.amountPaid > loan.balance) {\r\n             throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n         }\r\n \r\n-        // Create and save repayment\r\n+        // Create repayment\r\n         const repayment = await repaymentRepository.create(data);\r\n \r\n         // Update loan balance\r\n         loan.balance -= data.amountPaid;\r\n@@ -22,9 +21,9 @@\n \r\n         return repayment;\r\n     }\r\n \r\n-    // Update an existing repayment\r\n+    // Update repayment\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n@@ -44,44 +43,41 @@\n         repayment.paymentDate = data.paymentDate;\r\n         repayment.paymentTerm = data.paymentTerm;\r\n         repayment.description = data.description;\r\n \r\n-        await repaymentRepository.update(id, repayment); // use repo update\r\n+        await repaymentRepository.update(id, repayment);\r\n \r\n-        // Deduct updated repayment\r\n+        // Deduct updated amount\r\n         loan.balance -= repayment.amountPaid;\r\n         await loan.save();\r\n \r\n         return repayment;\r\n     }\r\n \r\n-    // Get all repayments\r\n-    async getAllRepayments() {\r\n-        return repaymentRepository.findAll();\r\n-    }\r\n-\r\n-    // Get repayments by loan\r\n-    async getRepaymentsByLoan(loanId) {\r\n-        return repaymentRepository.findByLoan(loanId);\r\n-    }\r\n-\r\n-    // Get repayment by ID\r\n-    async getRepaymentById(id) {\r\n-        return repaymentRepository.findById(id);\r\n-    }\r\n-\r\n     // Delete repayment\r\n     async deleteRepayment(id) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n         const loan = await Loan.findById(repayment.loan);\r\n         if (loan) {\r\n-            loan.balance += repayment.amountPaid; // refund\r\n+            loan.balance += repayment.amountPaid; // refund repayment\r\n             await loan.save();\r\n         }\r\n \r\n         return repaymentRepository.delete(id);\r\n     }\r\n+\r\n+    async getAllRepayments() {\r\n+        return repaymentRepository.findAll();\r\n+    }\r\n+\r\n+    async getRepaymentsByLoan(loanId) {\r\n+        return repaymentRepository.findByLoan(loanId);\r\n+    }\r\n+\r\n+    async getRepaymentById(id) {\r\n+        return repaymentRepository.findById(id);\r\n+    }\r\n }\r\n \r\n export default new RepaymentService();\r\n"
                },
                {
                    "date": 1770587599360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,7 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import Loan from \"../models/Loan.js\";\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../loan/loan.model.js\";\r\n \r\n class RepaymentService {\r\n     // Create repayment\r\n     async createRepayment(data) {\r\n@@ -79,5 +80,5 @@\n         return repaymentRepository.findById(id);\r\n     }\r\n }\r\n \r\n-export default new RepaymentService();\r\n+export default new RepaymentService();\n\\ No newline at end of file\n"
                },
                {
                    "date": 1770588176891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,74 +1,31 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n-import Loan from \"../loan/loan.model.js\";\r\n \r\n class RepaymentService {\r\n-    // Create repayment\r\n     async createRepayment(data) {\r\n-        const loan = await Loan.findById(data.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Validate repayment amount\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Create repayment\r\n-        const repayment = await repaymentRepository.create(data);\r\n-\r\n-        // Update loan balance\r\n-        loan.balance -= data.amountPaid;\r\n-        await loan.save();\r\n-\r\n+        // Step 1: Compute current loan balance\r\n+        const currentBalance = await computeLoanBalance(data.loan);\r\n+        // Step 2: Subtract the amount being paid\r\n+        const newBalance = currentBalance - data.amountPaid;\r\n+        // Step 3: Create repayment with remainingBalance set\r\n+        const repayment = await repaymentRepository.create({\r\n+            ...data,\r\n+            remainingBalance: Number(newBalance.toFixed(2)) // fix floating point\r\n+        });\r\n         return repayment;\r\n     }\r\n \r\n-    // Update repayment\r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // Revert previous repayment\r\n-        loan.balance += repayment.amountPaid;\r\n-\r\n-        // Validate new amount\r\n-        if (data.amountPaid > loan.balance) {\r\n-            throw new Error(`Amount exceeds remaining loan balance: ${loan.balance}`);\r\n-        }\r\n-\r\n-        // Update repayment fields\r\n-        repayment.amountPaid = data.amountPaid;\r\n-        repayment.paymentDate = data.paymentDate;\r\n-        repayment.paymentTerm = data.paymentTerm;\r\n-        repayment.description = data.description;\r\n-\r\n-        await repaymentRepository.update(id, repayment);\r\n-\r\n-        // Deduct updated amount\r\n-        loan.balance -= repayment.amountPaid;\r\n-        await loan.save();\r\n-\r\n-        return repayment;\r\n+        Object.assign(repayment, data);\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        return repayment.save();\r\n     }\r\n \r\n-    // Delete repayment\r\n-    async deleteRepayment(id) {\r\n-        const repayment = await repaymentRepository.findById(id);\r\n-        if (!repayment) throw new Error(\"Repayment not found\");\r\n-\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        if (loan) {\r\n-            loan.balance += repayment.amountPaid; // refund repayment\r\n-            await loan.save();\r\n-        }\r\n-\r\n-        return repaymentRepository.delete(id);\r\n-    }\r\n-\r\n     async getAllRepayments() {\r\n         return repaymentRepository.findAll();\r\n     }\r\n \r\n@@ -78,7 +35,11 @@\n \r\n     async getRepaymentById(id) {\r\n         return repaymentRepository.findById(id);\r\n     }\r\n+\r\n+    async deleteRepayment(id) {\r\n+        return repaymentRepository.delete(id);\r\n\\ No newline at end of file\n+    }\r\n }\r\n \r\n-export default new RepaymentService();\n+export default new RepaymentService();\r\n"
                },
                {
                    "date": 1770588257498,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,21 +2,22 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // Step 1: Compute current loan balance\r\n-        const currentBalance = await computeLoanBalance(data.loan);\r\n-        // Step 2: Subtract the amount being paid\r\n-        const newBalance = currentBalance - data.amountPaid;\r\n-        // Step 3: Create repayment with remainingBalance set\r\n-        const repayment = await repaymentRepository.create({\r\n-            ...data,\r\n-            remainingBalance: Number(newBalance.toFixed(2)) // fix floating point\r\n-        });\r\n+        // Step 1: Create repayment first\r\n+        const repayment = await repaymentRepository.create(data);\r\n+\r\n+        // Step 2: Compute balance including this repayment\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+\r\n+        // Step 3: Save updated repayment\r\n+        await repayment.save();\r\n+\r\n         return repayment;\r\n     }\r\n \r\n \r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n@@ -41,5 +42,5 @@\n         return repaymentRepository.delete(id);\r\n     }\r\n }\r\n \r\n-export default new RepaymentService();\n\\ No newline at end of file\n+export default new RepaymentService();\r\n"
                },
                {
                    "date": 1770588361041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,22 +2,31 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // Step 1: Create repayment first\r\n-        const repayment = await repaymentRepository.create(data);\r\n+        // Step 1: Get the loan\r\n+        const loan = await Loan.findById(data.loan);\r\n \r\n-        // Step 2: Compute balance including this repayment\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        // Step 2: Compute principal + interest\r\n+        let balance = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // Step 3: Save updated repayment\r\n-        await repayment.save();\r\n+        // Step 3: Subtract **all previous repayments**\r\n+        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n+        previousRepayments.forEach(rp => { balance -= rp.amountPaid || 0; });\r\n \r\n+        // Step 4: Compute remaining balance **after this repayment**\r\n+        const remainingBalance = balance - data.amountPaid;\r\n+\r\n+        // Step 5: Create repayment with remainingBalance\r\n+        const repayment = await repaymentRepository.create({\r\n+            ...data,\r\n+            remainingBalance: Number(remainingBalance.toFixed(2))\r\n+        });\r\n+\r\n         return repayment;\r\n     }\r\n \r\n \r\n-\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770588415231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,27 +2,30 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // Step 1: Get the loan\r\n+        // 1️⃣ Get the loan\r\n         const loan = await Loan.findById(data.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-        // Step 2: Compute principal + interest\r\n+        // 2️⃣ Compute current balance before this repayment\r\n         let balance = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // Step 3: Subtract **all previous repayments**\r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n-        previousRepayments.forEach(rp => { balance -= rp.amountPaid || 0; });\r\n+        previousRepayments.forEach(rp => {\r\n+            balance -= rp.amountPaid || 0;\r\n+        });\r\n \r\n-        // Step 4: Compute remaining balance **after this repayment**\r\n-        const remainingBalance = balance - data.amountPaid;\r\n+        // 3️⃣ Compute remaining balance after this repayment\r\n+        const remainingBalance = Number((balance - data.amountPaid).toFixed(2));\r\n \r\n-        // Step 5: Create repayment with remainingBalance\r\n+        // 4️⃣ Create the repayment with remainingBalance\r\n         const repayment = await repaymentRepository.create({\r\n             ...data,\r\n-            remainingBalance: Number(remainingBalance.toFixed(2))\r\n+            remainingBalance\r\n         });\r\n \r\n+        // 5️⃣ Return the repayment\r\n         return repayment;\r\n     }\r\n \r\n \r\n"
                },
                {
                    "date": 1770588638949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,34 +2,14 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // 1️⃣ Get the loan\r\n-        const loan = await Loan.findById(data.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // 2️⃣ Compute current balance before this repayment\r\n-        let balance = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n-\r\n-        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n-        previousRepayments.forEach(rp => {\r\n-            balance -= rp.amountPaid || 0;\r\n-        });\r\n-\r\n-        // 3️⃣ Compute remaining balance after this repayment\r\n-        const remainingBalance = Number((balance - data.amountPaid).toFixed(2));\r\n-\r\n-        // 4️⃣ Create the repayment with remainingBalance\r\n-        const repayment = await repaymentRepository.create({\r\n-            ...data,\r\n-            remainingBalance\r\n-        });\r\n-\r\n-        // 5️⃣ Return the repayment\r\n+        const repayment = await repaymentRepository.create(data);\r\n+        repayment.remainingBalance = await computeLoanBalance(data.loan);\r\n+        await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n-\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770588834299,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,11 +2,14 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n+        const balance = await computeLoanBalance(repayment.loan);\r\n+        const remainingBalance = balance - data.amountPaid;\r\n+        data.remainingBalance = remainingBalance;\r\n         const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(data.loan);\r\n-        await repayment.save();\r\n+        // repayment.remainingBalance = remainingBalance;\r\n+        // await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n     async updatePayment(id, data) {\r\n"
                },
                {
                    "date": 1770588873671,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        const balance = await computeLoanBalance(repayment.loan);\r\n+        const balance = await computeLoanBalance(data.loan);\r\n         const remainingBalance = balance - data.amountPaid;\r\n         data.remainingBalance = remainingBalance;\r\n         const repayment = await repaymentRepository.create(data);\r\n         // repayment.remainingBalance = remainingBalance;\r\n"
                },
                {
                    "date": 1770588899906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,9 @@\n class RepaymentService {\r\n     async createRepayment(data) {\r\n         const balance = await computeLoanBalance(data.loan);\r\n         const remainingBalance = balance - data.amountPaid;\r\n-        data.remainingBalance = remainingBalance;\r\n+        data.remainingBalance = remainingBalance + balance;\r\n         const repayment = await repaymentRepository.create(data);\r\n         // repayment.remainingBalance = remainingBalance;\r\n         // await repayment.save();\r\n         return repayment;\r\n"
                },
                {
                    "date": 1770589014026,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n+        alert(data.loan);\r\n         const balance = await computeLoanBalance(data.loan);\r\n         const remainingBalance = balance - data.amountPaid;\r\n         data.remainingBalance = remainingBalance + balance;\r\n         const repayment = await repaymentRepository.create(data);\r\n"
                },
                {
                    "date": 1770589046455,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        alert(data.loan);\r\n+        alert(11);\r\n         const balance = await computeLoanBalance(data.loan);\r\n         const remainingBalance = balance - data.amountPaid;\r\n         data.remainingBalance = remainingBalance + balance;\r\n         const repayment = await repaymentRepository.create(data);\r\n"
                },
                {
                    "date": 1770589059659,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,15 +2,11 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        alert(11);\r\n-        const balance = await computeLoanBalance(data.loan);\r\n-        const remainingBalance = balance - data.amountPaid;\r\n-        data.remainingBalance = remainingBalance + balance;\r\n         const repayment = await repaymentRepository.create(data);\r\n-        // repayment.remainingBalance = remainingBalance;\r\n-        // await repayment.save();\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+        await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n     async updatePayment(id, data) {\r\n"
                },
                {
                    "date": 1770589074366,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n+        alert(222)\r\n         const repayment = await repaymentRepository.create(data);\r\n         repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n         await repayment.save();\r\n         return repayment;\r\n"
                },
                {
                    "date": 1770589097948,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        alert(222)\r\n+        console.log(\"Creating repayment with data:\", data); \r\n         const repayment = await repaymentRepository.create(data);\r\n         repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n         await repayment.save();\r\n         return repayment;\r\n"
                },
                {
                    "date": 1770589259391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,15 +2,31 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        console.log(\"Creating repayment with data:\", data); \r\n-        const repayment = await repaymentRepository.create(data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n-        await repayment.save();\r\n+        // 1️⃣ Compute total loan + interest\r\n+        const loan = await Loan.findById(data.loan);\r\n+        if (!loan) throw new Error(\"Loan not found\");\r\n+\r\n+        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n+\r\n+        // 2️⃣ Compute sum of **all previous repayments**\r\n+        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n+        const paid = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n+\r\n+        // 3️⃣ Remaining balance **after this payment**\r\n+        const remainingBalance = Number((totalLoan - paid - data.amountPaid).toFixed(2));\r\n+\r\n+        // 4️⃣ Create repayment with correct remainingBalance\r\n+        const repayment = await repaymentRepository.create({\r\n+            ...data,\r\n+            remainingBalance\r\n+        });\r\n+\r\n         return repayment;\r\n     }\r\n \r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770589382534,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,31 +2,31 @@\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // 1️⃣ Compute total loan + interest\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n         const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // 2️⃣ Compute sum of **all previous repayments**\r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n         const paid = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n \r\n-        // 3️⃣ Remaining balance **after this payment**\r\n         const remainingBalance = Number((totalLoan - paid - data.amountPaid).toFixed(2));\r\n \r\n-        // 4️⃣ Create repayment with correct remainingBalance\r\n-        const repayment = await repaymentRepository.create({\r\n+        // Create repayment as Mongoose document\r\n+        const repayment = new Repayment({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n \r\n+        await repayment.save(); // ✅ safe here because we used `new Repayment()`\r\n+\r\n         return repayment;\r\n     }\r\n \r\n \r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770589475990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,7 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n+import Loan from \"../loan/loan.model.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n         const loan = await Loan.findById(data.loan);\r\n"
                },
                {
                    "date": 1770589503226,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n import Loan from \"../loan/loan.model.js\";\r\n+import Repayment from \"./repayment.model.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n         const loan = await Loan.findById(data.loan);\r\n"
                },
                {
                    "date": 1770589719565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,25 +10,20 @@\n \r\n         const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n-        const paid = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n+        const sumPrevious = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n \r\n-        const remainingBalance = Number((totalLoan - paid - data.amountPaid).toFixed(2));\r\n+        const remainingBalance = Number((totalLoan - sumPrevious - data.amountPaid).toFixed(2));\r\n \r\n-        // Create repayment as Mongoose document\r\n-        const repayment = new Repayment({\r\n+        const repayment = await repaymentRepository.create({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n \r\n-        await repayment.save(); // ✅ safe here because we used `new Repayment()`\r\n-\r\n         return repayment;\r\n     }\r\n \r\n-\r\n-\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770589853051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,18 +4,23 @@\n import Repayment from \"./repayment.model.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n+        // 1️⃣ Get the loan\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n+        // 2️⃣ Compute total loan with interest\r\n         const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n+        // 3️⃣ Sum of previous repayments\r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n         const sumPrevious = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n \r\n+        // 4️⃣ Remaining balance after this repayment\r\n         const remainingBalance = Number((totalLoan - sumPrevious - data.amountPaid).toFixed(2));\r\n \r\n+        // 5️⃣ Create repayment in DB with correct remainingBalance\r\n         const repayment = await repaymentRepository.create({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n"
                },
                {
                    "date": 1770589928363,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,27 +8,30 @@\n         // 1️⃣ Get the loan\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-        // 2️⃣ Compute total loan with interest\r\n+        // 2️⃣ Compute total loan (principal + interest)\r\n         const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // 3️⃣ Sum of previous repayments\r\n+        // 3️⃣ Compute sum of previous repayments (exclude current)\r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n         const sumPrevious = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n \r\n-        // 4️⃣ Remaining balance after this repayment\r\n+        // 4️⃣ Compute remaining balance *after this payment*\r\n         const remainingBalance = Number((totalLoan - sumPrevious - data.amountPaid).toFixed(2));\r\n \r\n-        // 5️⃣ Create repayment in DB with correct remainingBalance\r\n-        const repayment = await repaymentRepository.create({\r\n+        // 5️⃣ Create the repayment with remainingBalance **before saving**\r\n+        const repayment = new Repayment({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n \r\n+        await repayment.save(); // ✅ Save with remainingBalance already set\r\n+\r\n         return repayment;\r\n     }\r\n \r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770590001985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,34 +4,36 @@\n import Repayment from \"./repayment.model.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        // 1️⃣ Get the loan\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-        // 2️⃣ Compute total loan (principal + interest)\r\n+        // Total loan including interest\r\n         const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // 3️⃣ Compute sum of previous repayments (exclude current)\r\n+        // Remaining balance AFTER this repayment\r\n+        // For first repayment, ignore previous repayments\r\n+        // If you want to include previous repayments, subtract them here\r\n         const previousRepayments = await Repayment.find({ loan: data.loan });\r\n         const sumPrevious = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n \r\n-        // 4️⃣ Compute remaining balance *after this payment*\r\n-        const remainingBalance = Number((totalLoan - sumPrevious - data.amountPaid).toFixed(2));\r\n+        // remainingBalance = total loan - current payment\r\n+        const remainingBalance = Number((totalLoan - data.amountPaid).toFixed(2));\r\n \r\n-        // 5️⃣ Create the repayment with remainingBalance **before saving**\r\n+        // Create repayment with remainingBalance BEFORE saving\r\n         const repayment = new Repayment({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n \r\n-        await repayment.save(); // ✅ Save with remainingBalance already set\r\n+        await repayment.save();\r\n \r\n         return repayment;\r\n     }\r\n \r\n \r\n+\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n"
                },
                {
                    "date": 1770590123056,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,19 +8,10 @@\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n         // Total loan including interest\r\n-        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n+        const remainingBalance = loan.balance - data.amountPaid; // Assuming balance is total loan amount including interest\r\n \r\n-        // Remaining balance AFTER this repayment\r\n-        // For first repayment, ignore previous repayments\r\n-        // If you want to include previous repayments, subtract them here\r\n-        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n-        const sumPrevious = previousRepayments.reduce((sum, r) => sum + (r.amountPaid || 0), 0);\r\n-\r\n-        // remainingBalance = total loan - current payment\r\n-        const remainingBalance = Number((totalLoan - data.amountPaid).toFixed(2));\r\n-\r\n         // Create repayment with remainingBalance BEFORE saving\r\n         const repayment = new Repayment({\r\n             ...data,\r\n             remainingBalance\r\n"
                },
                {
                    "date": 1770590156909,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n         // Total loan including interest\r\n-        const remainingBalance = loan.balance - data.amountPaid; // Assuming balance is total loan amount including interest\r\n+        const remainingBalance = loan.balance || 0 - data.amountPaid || 0; // Assuming balance is total loan amount including interest\r\n \r\n         // Create repayment with remainingBalance BEFORE saving\r\n         const repayment = new Repayment({\r\n             ...data,\r\n"
                },
                {
                    "date": 1770590170237,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n         // Total loan including interest\r\n-        const remainingBalance = loan.balance || 0 - data.amountPaid || 0; // Assuming balance is total loan amount including interest\r\n+        const remainingBalance = 200; // Assuming balance is total loan amount including interest\r\n \r\n         // Create repayment with remainingBalance BEFORE saving\r\n         const repayment = new Repayment({\r\n             ...data,\r\n"
                },
                {
                    "date": 1770590286687,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,36 +1,58 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n import Loan from \"../loan/loan.model.js\";\r\n import Repayment from \"./repayment.model.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n         const loan = await Loan.findById(data.loan);\r\n         if (!loan) throw new Error(\"Loan not found\");\r\n \r\n-        // Total loan including interest\r\n-        const remainingBalance = 200; // Assuming balance is total loan amount including interest\r\n+        // 1️⃣ Total loan including interest\r\n+        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n \r\n-        // Create repayment with remainingBalance BEFORE saving\r\n+        // 2️⃣ Sum of previous repayments\r\n+        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n+        const sumPrevious = previousRepayments.reduce(\r\n+            (sum, r) => sum + (r.amountPaid || 0),\r\n+            0\r\n+        );\r\n+\r\n+        // 3️⃣ Remaining balance after this payment\r\n+        const remainingBalance = Number(\r\n+            (totalLoan - sumPrevious - data.amountPaid).toFixed(2)\r\n+        );\r\n+\r\n+        // 4️⃣ Create repayment with remainingBalance BEFORE saving\r\n         const repayment = new Repayment({\r\n             ...data,\r\n             remainingBalance\r\n         });\r\n \r\n         await repayment.save();\r\n-\r\n         return repayment;\r\n     }\r\n \r\n-\r\n-\r\n     async updatePayment(id, data) {\r\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n         Object.assign(repayment, data);\r\n-        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n+\r\n+        // Recalculate remaining balance after update\r\n+        const loan = await Loan.findById(repayment.loan);\r\n+        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n+\r\n+        const previousRepayments = await Repayment.find({ loan: repayment.loan, _id: { $ne: repayment._id } });\r\n+        const sumPrevious = previousRepayments.reduce(\r\n+            (sum, r) => sum + (r.amountPaid || 0),\r\n+            0\r\n+        );\r\n+\r\n+        repayment.remainingBalance = Number(\r\n+            (totalLoan - sumPrevious - repayment.amountPaid).toFixed(2)\r\n+        );\r\n+\r\n         return repayment.save();\r\n     }\r\n \r\n     async getAllRepayments() {\r\n"
                },
                {
                    "date": 1770590544002,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,34 +1,11 @@\n import repaymentRepository from \"./repayment.repository.js\";\r\n-import Loan from \"../loan/loan.model.js\";\r\n-import Repayment from \"./repayment.model.js\";\r\n+import { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n \r\n class RepaymentService {\r\n     async createRepayment(data) {\r\n-        const loan = await Loan.findById(data.loan);\r\n-        if (!loan) throw new Error(\"Loan not found\");\r\n-\r\n-        // 1️⃣ Total loan including interest\r\n-        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n-\r\n-        // 2️⃣ Sum of previous repayments\r\n-        const previousRepayments = await Repayment.find({ loan: data.loan });\r\n-        const sumPrevious = previousRepayments.reduce(\r\n-            (sum, r) => sum + (r.amountPaid || 0),\r\n-            0\r\n-        );\r\n-\r\n-        // 3️⃣ Remaining balance after this payment\r\n-        const remainingBalance = Number(\r\n-            (totalLoan - sumPrevious - data.amountPaid).toFixed(2)\r\n-        );\r\n-\r\n-        // 4️⃣ Create repayment with remainingBalance BEFORE saving\r\n-        const repayment = new Repayment({\r\n-            ...data,\r\n-            remainingBalance\r\n-        });\r\n-\r\n+        const repayment = await repaymentRepository.create(data);\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n         await repayment.save();\r\n         return repayment;\r\n     }\r\n \r\n@@ -36,23 +13,9 @@\n         const repayment = await repaymentRepository.findById(id);\r\n         if (!repayment) throw new Error(\"Repayment not found\");\r\n \r\n         Object.assign(repayment, data);\r\n-\r\n-        // Recalculate remaining balance after update\r\n-        const loan = await Loan.findById(repayment.loan);\r\n-        const totalLoan = loan.amount + (loan.amount * loan.interestRate) / 100;\r\n-\r\n-        const previousRepayments = await Repayment.find({ loan: repayment.loan, _id: { $ne: repayment._id } });\r\n-        const sumPrevious = previousRepayments.reduce(\r\n-            (sum, r) => sum + (r.amountPaid || 0),\r\n-            0\r\n-        );\r\n-\r\n-        repayment.remainingBalance = Number(\r\n-            (totalLoan - sumPrevious - repayment.amountPaid).toFixed(2)\r\n-        );\r\n-\r\n+        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n         return repayment.save();\r\n     }\r\n \r\n     async getAllRepayments() {\r\n"
                }
            ],
            "date": 1770586657525,
            "name": "Commit-0",
            "content": "import repaymentRepository from \"./repayment.repository.js\";\r\nimport { computeLoanBalance } from \"../utils/balanceCalculator.js\";\r\n\r\nclass RepaymentService {\r\n    async createRepayment(data) {\r\n        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n        const repayment = await repaymentRepository.create(data);\r\n        await repayment.save();\r\n        return repayment;\r\n    }\r\n\r\n    async updatePayment(id, data) {\r\n        const repayment = await repaymentRepository.findById(id);\r\n        if (!repayment) throw new Error(\"Repayment not found\");\r\n\r\n        Object.assign(repayment, data);\r\n        repayment.remainingBalance = await computeLoanBalance(repayment.loan);\r\n        return repayment.save();\r\n    }\r\n\r\n    async getAllRepayments() {\r\n        return repaymentRepository.findAll();\r\n    }\r\n\r\n    async getRepaymentsByLoan(loanId) {\r\n        return repaymentRepository.findByLoan(loanId);\r\n    }\r\n\r\n    async getRepaymentById(id) {\r\n        return repaymentRepository.findById(id);\r\n    }\r\n\r\n    async deleteRepayment(id) {\r\n        return repaymentRepository.delete(id);\r\n    }\r\n}\r\n\r\nexport default new RepaymentService();\r\n"
        }
    ]
}