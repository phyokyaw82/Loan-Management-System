{
    "sourceFile": "src/modules/contract/contract.controller.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1770570317899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770570407704,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,80 +1,98 @@\n-import Contract from \"./contract.model.js\";\r\n+import contractService from \"./contract.service.js\";\r\n+import fs from \"fs\";\r\n+import path from \"path\";\r\n \r\n-export const upload = async (req, res) => {\r\n-    try {\r\n-        const { loan, signingDate } = req.body;\r\n-        if (!loan || !signingDate)\r\n-            return res.status(400).json({ error: \"Loan and signingDate are required\" });\r\n+class ContractController {\r\n+    // Create/upload new contract\r\n+    async upload(req, res) {\r\n+        try {\r\n+            if (!req.file) return res.status(400).json({ error: \"No file uploaded\" });\r\n \r\n-        const contract = new Contract({\r\n-            loan,\r\n-            signingDate,\r\n-            documentUrl: req.file ? req.file.path : null,\r\n-        });\r\n+            const documentPath = req.file.path.startsWith(\"/\")\r\n+                ? req.file.path.slice(1)\r\n+                : req.file.path;\r\n \r\n-        await contract.save();\r\n-        res.status(201).json(contract);\r\n-    } catch (err) {\r\n-        console.error(err);\r\n-        res.status(500).json({ error: \"Error saving contract\" });\r\n+            const data = {\r\n+                loan: req.body.loan,\r\n+                signingDate: req.body.signingDate,\r\n+                documentUrl: documentPath,\r\n+            };\r\n+\r\n+            const contract = await contractService.createContract(data);\r\n+            res.status(201).json(contract);\r\n+        } catch (err) {\r\n+            res.status(400).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const update = async (req, res) => {\r\n-    try {\r\n-        const { id } = req.params;\r\n-        const { loan, signingDate } = req.body;\r\n+    async getAll(req, res) {\r\n+        try {\r\n+            const contracts = await contractService.getAllContracts();\r\n+            res.json(contracts);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n+    }\r\n \r\n-        const contract = await Contract.findById(id);\r\n-        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n+    async getById(req, res) {\r\n+        try {\r\n+            const contract = await contractService.getContractById(req.params.id);\r\n+            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n+            res.json(contract);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n+    }\r\n \r\n-        contract.loan = loan;\r\n-        contract.signingDate = signingDate;\r\n+    async getByLoan(req, res) {\r\n+        try {\r\n+            const contracts = await contractService.getContractsByLoan(req.params.loanId);\r\n+            res.json(contracts);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n+    }\r\n \r\n-        if (req.file) contract.documentUrl = req.file.path;\r\n+    // Update existing contract\r\n+    async update(req, res) {\r\n+        try {\r\n+            const contractId = req.params.id;\r\n+            const contract = await contractService.getContractById(contractId);\r\n+            if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n \r\n-        await contract.save();\r\n-        res.json(contract);\r\n-    } catch (err) {\r\n-        console.error(err);\r\n-        res.status(500).json({ error: \"Error saving contract\" });\r\n-    }\r\n-};\r\n+            // Update fields\r\n+            if (req.body.loan) contract.loan = req.body.loan;\r\n+            if (req.body.signingDate) contract.signingDate = req.body.signingDate;\r\n \r\n-export const getAll = async (req, res) => {\r\n-    try {\r\n-        const contracts = await Contract.find().populate(\"loan\");\r\n-        res.json(contracts);\r\n-    } catch (err) {\r\n-        res.status(500).json({ error: \"Error fetching contracts\" });\r\n-    }\r\n-};\r\n+            // Replace document if new file uploaded\r\n+            if (req.file) {\r\n+                let documentPath = req.file.path;\r\n+                if (documentPath.startsWith(\"/\")) documentPath = documentPath.slice(1);\r\n+                contract.documentUrl = documentPath;\r\n+            }\r\n \r\n-export const getById = async (req, res) => {\r\n-    try {\r\n-        const contract = await Contract.findById(req.params.id).populate(\"loan\");\r\n-        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n-        res.json(contract);\r\n-    } catch (err) {\r\n-        res.status(500).json({ error: \"Error fetching contract\" });\r\n+            await contract.save();\r\n+            res.json(contract); // Return updated contract with the new documentUrl\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const getByLoan = async (req, res) => {\r\n-    try {\r\n-        const contracts = await Contract.find({ loan: req.params.loanId }).populate(\"loan\");\r\n-        res.json(contracts);\r\n-    } catch (err) {\r\n-        res.status(500).json({ error: \"Error fetching contracts\" });\r\n+    async delete(req, res) {\r\n+        try {\r\n+            const contract = await contractService.getContractById(req.params.id);\r\n+            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n+\r\n+            // Delete file from server\r\n+            const filePath = path.join(process.cwd(), contract.documentUrl);\r\n+            if (fs.existsSync(filePath)) fs.unlinkSync(filePath);\r\n+\r\n+            await contractService.deleteContract(req.params.id);\r\n+            res.json({ message: \"Deleted successfully\" });\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n+}\r\n \r\n-export const deleteContract = async (req, res) => {\r\n-    try {\r\n-        const contract = await Contract.findByIdAndDelete(req.params.id);\r\n-        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n-        res.json({ message: \"Contract deleted\" });\r\n-    } catch (err) {\r\n-        res.status(500).json({ error: \"Error deleting contract\" });\r\n-    }\r\n-};\r\n+export default new ContractController();\r\n"
                },
                {
                    "date": 1770571295675,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,98 +1,85 @@\n-import contractService from \"./contract.service.js\";\r\n-import fs from \"fs\";\r\n-import path from \"path\";\r\n+import mongoose from \"mongoose\";\r\n \r\n-class ContractController {\r\n-    // Create/upload new contract\r\n-    async upload(req, res) {\r\n-        try {\r\n-            if (!req.file) return res.status(400).json({ error: \"No file uploaded\" });\r\n+const contractSchema = new mongoose.Schema(\r\n+    {\r\n+        loan: { type: mongoose.Schema.Types.ObjectId, ref: \"Loan\", required: true },\r\n+        documentUrl: { type: String, required: true },\r\n+        signingDate: { type: Date, required: true },\r\n+    },\r\n+    { timestamps: true }\r\n+);\r\n \r\n-            const documentPath = req.file.path.startsWith(\"/\")\r\n-                ? req.file.path.slice(1)\r\n-                : req.file.path;\r\n+export default mongoose.model(\"Contract\", contractSchema);\r\n+import Contract from \"./contract.model.js\";\r\n \r\n-            const data = {\r\n-                loan: req.body.loan,\r\n-                signingDate: req.body.signingDate,\r\n-                documentUrl: documentPath,\r\n-            };\r\n+export const upload = async (req, res) => {\r\n+    try {\r\n+        const { loan, signingDate } = req.body;\r\n+        const documentUrl = req.file ? req.file.filename : null;\r\n \r\n-            const contract = await contractService.createContract(data);\r\n-            res.status(201).json(contract);\r\n-        } catch (err) {\r\n-            res.status(400).json({ error: err.message });\r\n-        }\r\n+        if (!loan || !signingDate || !documentUrl)\r\n+            return res.status(400).json({ message: \"Missing required fields\" });\r\n+\r\n+        const contract = await Contract.create({ loan, signingDate, documentUrl });\r\n+        res.status(201).json(contract);\r\n+    } catch (err) {\r\n+        console.error(\"Contract upload error:\", err);\r\n+        res.status(500).json({ message: \"Error saving contract\" });\r\n     }\r\n+};\r\n \r\n-    async getAll(req, res) {\r\n-        try {\r\n-            const contracts = await contractService.getAllContracts();\r\n-            res.json(contracts);\r\n-        } catch (err) {\r\n-            res.status(500).json({ error: err.message });\r\n-        }\r\n+export const update = async (req, res) => {\r\n+    try {\r\n+        const { loan, signingDate } = req.body;\r\n+        const contract = await Contract.findById(req.params.id);\r\n+        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n+\r\n+        contract.loan = loan || contract.loan;\r\n+        contract.signingDate = signingDate || contract.signingDate;\r\n+        if (req.file) contract.documentUrl = req.file.filename;\r\n+\r\n+        await contract.save();\r\n+        res.json(contract);\r\n+    } catch (err) {\r\n+        console.error(\"Contract update error:\", err);\r\n+        res.status(500).json({ message: \"Error updating contract\" });\r\n     }\r\n+};\r\n \r\n-    async getById(req, res) {\r\n-        try {\r\n-            const contract = await contractService.getContractById(req.params.id);\r\n-            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n-            res.json(contract);\r\n-        } catch (err) {\r\n-            res.status(500).json({ error: err.message });\r\n-        }\r\n+export const getAll = async (req, res) => {\r\n+    try {\r\n+        const contracts = await Contract.find().populate(\"loan\", \"borrower amount\");\r\n+        res.json(contracts);\r\n+    } catch (err) {\r\n+        res.status(500).json({ message: \"Error fetching contracts\" });\r\n     }\r\n+};\r\n \r\n-    async getByLoan(req, res) {\r\n-        try {\r\n-            const contracts = await contractService.getContractsByLoan(req.params.loanId);\r\n-            res.json(contracts);\r\n-        } catch (err) {\r\n-            res.status(500).json({ error: err.message });\r\n-        }\r\n+export const getById = async (req, res) => {\r\n+    try {\r\n+        const contract = await Contract.findById(req.params.id).populate(\"loan\", \"borrower amount\");\r\n+        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n+        res.json(contract);\r\n+    } catch (err) {\r\n+        res.status(500).json({ message: \"Error fetching contract\" });\r\n     }\r\n+};\r\n \r\n-    // Update existing contract\r\n-    async update(req, res) {\r\n-        try {\r\n-            const contractId = req.params.id;\r\n-            const contract = await contractService.getContractById(contractId);\r\n-            if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n-\r\n-            // Update fields\r\n-            if (req.body.loan) contract.loan = req.body.loan;\r\n-            if (req.body.signingDate) contract.signingDate = req.body.signingDate;\r\n-\r\n-            // Replace document if new file uploaded\r\n-            if (req.file) {\r\n-                let documentPath = req.file.path;\r\n-                if (documentPath.startsWith(\"/\")) documentPath = documentPath.slice(1);\r\n-                contract.documentUrl = documentPath;\r\n-            }\r\n-\r\n-            await contract.save();\r\n-            res.json(contract); // Return updated contract with the new documentUrl\r\n-        } catch (err) {\r\n-            res.status(500).json({ error: err.message });\r\n-        }\r\n+export const getByLoan = async (req, res) => {\r\n+    try {\r\n+        const contracts = await Contract.find({ loan: req.params.loanId });\r\n+        res.json(contracts);\r\n+    } catch (err) {\r\n+        res.status(500).json({ message: \"Error fetching contract by loan\" });\r\n     }\r\n+};\r\n \r\n-    async delete(req, res) {\r\n-        try {\r\n-            const contract = await contractService.getContractById(req.params.id);\r\n-            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n-\r\n-            // Delete file from server\r\n-            const filePath = path.join(process.cwd(), contract.documentUrl);\r\n-            if (fs.existsSync(filePath)) fs.unlinkSync(filePath);\r\n-\r\n-            await contractService.deleteContract(req.params.id);\r\n-            res.json({ message: \"Deleted successfully\" });\r\n-        } catch (err) {\r\n-            res.status(500).json({ error: err.message });\r\n-        }\r\n+export const deleteContract = async (req, res) => {\r\n+    try {\r\n+        const contract = await Contract.findByIdAndDelete(req.params.id);\r\n+        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n+        res.json({ message: \"Contract deleted\" });\r\n+    } catch (err) {\r\n+        res.status(500).json({ message: \"Error deleting contract\" });\r\n     }\r\n-}\r\n-\r\n-export default new ContractController();\r\n+};\r\n"
                },
                {
                    "date": 1770571365929,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,85 +1,98 @@\n-import mongoose from \"mongoose\";\r\n+import contractService from \"./contract.service.js\";\r\n+import fs from \"fs\";\r\n+import path from \"path\";\r\n \r\n-const contractSchema = new mongoose.Schema(\r\n-    {\r\n-        loan: { type: mongoose.Schema.Types.ObjectId, ref: \"Loan\", required: true },\r\n-        documentUrl: { type: String, required: true },\r\n-        signingDate: { type: Date, required: true },\r\n-    },\r\n-    { timestamps: true }\r\n-);\r\n+class ContractController {\r\n+    // Create/upload new contract\r\n+    async upload(req, res) {\r\n+        try {\r\n+            if (!req.file) return res.status(400).json({ error: \"No file uploaded\" });\r\n \r\n-export default mongoose.model(\"Contract\", contractSchema);\r\n-import Contract from \"./contract.model.js\";\r\n+            const documentPath = req.file.path.startsWith(\"/\")\r\n+                ? req.file.path.slice(1)\r\n+                : req.file.path;\r\n \r\n-export const upload = async (req, res) => {\r\n-    try {\r\n-        const { loan, signingDate } = req.body;\r\n-        const documentUrl = req.file ? req.file.filename : null;\r\n+            const data = {\r\n+                loan: req.body.loan,\r\n+                signingDate: req.body.signingDate,\r\n+                documentUrl: documentPath,\r\n+            };\r\n \r\n-        if (!loan || !signingDate || !documentUrl)\r\n-            return res.status(400).json({ message: \"Missing required fields\" });\r\n+            const contract = await contractService.createContract(data);\r\n+            res.status(201).json(contract);\r\n+        } catch (err) {\r\n+            res.status(400).json({ error: err.message });\r\n+        }\r\n+    }\r\n \r\n-        const contract = await Contract.create({ loan, signingDate, documentUrl });\r\n-        res.status(201).json(contract);\r\n-    } catch (err) {\r\n-        console.error(\"Contract upload error:\", err);\r\n-        res.status(500).json({ message: \"Error saving contract\" });\r\n+    async getAll(req, res) {\r\n+        try {\r\n+            const contracts = await contractService.getAllContracts();\r\n+            res.json(contracts);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const update = async (req, res) => {\r\n-    try {\r\n-        const { loan, signingDate } = req.body;\r\n-        const contract = await Contract.findById(req.params.id);\r\n-        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n-\r\n-        contract.loan = loan || contract.loan;\r\n-        contract.signingDate = signingDate || contract.signingDate;\r\n-        if (req.file) contract.documentUrl = req.file.filename;\r\n-\r\n-        await contract.save();\r\n-        res.json(contract);\r\n-    } catch (err) {\r\n-        console.error(\"Contract update error:\", err);\r\n-        res.status(500).json({ message: \"Error updating contract\" });\r\n+    async getById(req, res) {\r\n+        try {\r\n+            const contract = await contractService.getContractById(req.params.id);\r\n+            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n+            res.json(contract);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const getAll = async (req, res) => {\r\n-    try {\r\n-        const contracts = await Contract.find().populate(\"loan\", \"borrower amount\");\r\n-        res.json(contracts);\r\n-    } catch (err) {\r\n-        res.status(500).json({ message: \"Error fetching contracts\" });\r\n+    async getByLoan(req, res) {\r\n+        try {\r\n+            const contracts = await contractService.getContractsByLoan(req.params.loanId);\r\n+            res.json(contracts);\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const getById = async (req, res) => {\r\n-    try {\r\n-        const contract = await Contract.findById(req.params.id).populate(\"loan\", \"borrower amount\");\r\n-        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n-        res.json(contract);\r\n-    } catch (err) {\r\n-        res.status(500).json({ message: \"Error fetching contract\" });\r\n+    // Update existing contract\r\n+    async update(req, res) {\r\n+        try {\r\n+            const contractId = req.params.id;\r\n+            const contract = await contractService.getContractById(contractId);\r\n+            if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n+\r\n+            // Update fields\r\n+            if (req.body.loan) contract.loan = req.body.loan;\r\n+            if (req.body.signingDate) contract.signingDate = req.body.signingDate;\r\n+\r\n+            // Replace document if new file uploaded\r\n+            if (req.file) {\r\n+                let documentPath = req.file.path;\r\n+                if (documentPath.startsWith(\"/\")) documentPath = documentPath.slice(1);\r\n+                contract.documentUrl = documentPath;\r\n+            }\r\n+\r\n+            await contract.save();\r\n+            res.json(contract); // Return updated contract with the new documentUrl\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n \r\n-export const getByLoan = async (req, res) => {\r\n-    try {\r\n-        const contracts = await Contract.find({ loan: req.params.loanId });\r\n-        res.json(contracts);\r\n-    } catch (err) {\r\n-        res.status(500).json({ message: \"Error fetching contract by loan\" });\r\n+    async delete(req, res) {\r\n+        try {\r\n+            const contract = await contractService.getContractById(req.params.id);\r\n+            if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n+\r\n+            // Delete file from server\r\n+            const filePath = path.join(process.cwd(), contract.documentUrl);\r\n+            if (fs.existsSync(filePath)) fs.unlinkSync(filePath);\r\n+\r\n+            await contractService.deleteContract(req.params.id);\r\n+            res.json({ message: \"Deleted successfully\" });\r\n+        } catch (err) {\r\n+            res.status(500).json({ error: err.message });\r\n+        }\r\n     }\r\n-};\r\n+}\r\n \r\n-export const deleteContract = async (req, res) => {\r\n-    try {\r\n-        const contract = await Contract.findByIdAndDelete(req.params.id);\r\n-        if (!contract) return res.status(404).json({ message: \"Contract not found\" });\r\n-        res.json({ message: \"Contract deleted\" });\r\n-    } catch (err) {\r\n-        res.status(500).json({ message: \"Error deleting contract\" });\r\n-    }\r\n-};\r\n+export default new ContractController();\r\n"
                },
                {
                    "date": 1770574047219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,17 +82,24 @@\n         try {\r\n             const contract = await contractService.getContractById(req.params.id);\r\n             if (!contract) return res.status(404).json({ error: \"Not found\" });\r\n \r\n-            // Delete file from server\r\n-            const filePath = path.join(process.cwd(), contract.documentUrl);\r\n-            if (fs.existsSync(filePath)) fs.unlinkSync(filePath);\r\n+            if (contract.documentUrl) {\r\n+                // Normalize path (VERY IMPORTANT)\r\n+                const normalizedPath = contract.documentUrl.replace(/\\\\/g, \"/\");\r\n+                const filePath = path.resolve(process.cwd(), normalizedPath);\r\n \r\n+                if (fs.existsSync(filePath)) {\r\n+                    fs.unlinkSync(filePath);\r\n+                }\r\n+            }\r\n+\r\n             await contractService.deleteContract(req.params.id);\r\n             res.json({ message: \"Deleted successfully\" });\r\n         } catch (err) {\r\n             res.status(500).json({ error: err.message });\r\n         }\r\n     }\r\n+\r\n }\r\n \r\n export default new ContractController();\r\n"
                },
                {
                    "date": 1770574081304,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,8 +98,7 @@\n         } catch (err) {\r\n             res.status(500).json({ error: err.message });\r\n         }\r\n     }\r\n-\r\n }\r\n \r\n export default new ContractController();\r\n"
                }
            ],
            "date": 1770570317899,
            "name": "Commit-0",
            "content": "import Contract from \"./contract.model.js\";\r\n\r\nexport const upload = async (req, res) => {\r\n    try {\r\n        const { loan, signingDate } = req.body;\r\n        if (!loan || !signingDate)\r\n            return res.status(400).json({ error: \"Loan and signingDate are required\" });\r\n\r\n        const contract = new Contract({\r\n            loan,\r\n            signingDate,\r\n            documentUrl: req.file ? req.file.path : null,\r\n        });\r\n\r\n        await contract.save();\r\n        res.status(201).json(contract);\r\n    } catch (err) {\r\n        console.error(err);\r\n        res.status(500).json({ error: \"Error saving contract\" });\r\n    }\r\n};\r\n\r\nexport const update = async (req, res) => {\r\n    try {\r\n        const { id } = req.params;\r\n        const { loan, signingDate } = req.body;\r\n\r\n        const contract = await Contract.findById(id);\r\n        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n\r\n        contract.loan = loan;\r\n        contract.signingDate = signingDate;\r\n\r\n        if (req.file) contract.documentUrl = req.file.path;\r\n\r\n        await contract.save();\r\n        res.json(contract);\r\n    } catch (err) {\r\n        console.error(err);\r\n        res.status(500).json({ error: \"Error saving contract\" });\r\n    }\r\n};\r\n\r\nexport const getAll = async (req, res) => {\r\n    try {\r\n        const contracts = await Contract.find().populate(\"loan\");\r\n        res.json(contracts);\r\n    } catch (err) {\r\n        res.status(500).json({ error: \"Error fetching contracts\" });\r\n    }\r\n};\r\n\r\nexport const getById = async (req, res) => {\r\n    try {\r\n        const contract = await Contract.findById(req.params.id).populate(\"loan\");\r\n        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n        res.json(contract);\r\n    } catch (err) {\r\n        res.status(500).json({ error: \"Error fetching contract\" });\r\n    }\r\n};\r\n\r\nexport const getByLoan = async (req, res) => {\r\n    try {\r\n        const contracts = await Contract.find({ loan: req.params.loanId }).populate(\"loan\");\r\n        res.json(contracts);\r\n    } catch (err) {\r\n        res.status(500).json({ error: \"Error fetching contracts\" });\r\n    }\r\n};\r\n\r\nexport const deleteContract = async (req, res) => {\r\n    try {\r\n        const contract = await Contract.findByIdAndDelete(req.params.id);\r\n        if (!contract) return res.status(404).json({ error: \"Contract not found\" });\r\n        res.json({ message: \"Contract deleted\" });\r\n    } catch (err) {\r\n        res.status(500).json({ error: \"Error deleting contract\" });\r\n    }\r\n};\r\n"
        }
    ]
}